import jlib from 'jingtum-lib';
import ipfsAPI from 'ipfs-api';
import mysql from 'mysql';
import sqlText from 'node-transform-mysql';

import * as requestInfo from '../utils/jingtum/requestInfo.js';
import * as contract from '../utils/jingtum/contract.js';
import * as ipfsUtils from '../utils/ipfsUtils.js';
import * as mysqlUtils from '../utils/mysqlUtils.js';

import {chains, ipfsConf, mysqlConf} from '../utils/info.js';

const ipfs = ipfsAPI(ipfsConf); // ipfs连接
const c = mysql.createConnection(mysqlConf);
c.connect(); // mysql连接
const contractChain = chains[1];
//买单合约：智能交易系统 卖单合约：平台
const platformAddr = contractChain.account.a[5].address;
const platformSecret = contractChain.account.a[5].secret;
// 一次部署一个 abi 和 payload
const abi = [{"constant":false,"inputs":[{"name":"nonce","type":"string"},{"name":"maker_addr","type":"address"},{"name":"system_id","type":"string"}],"name":"acceptOrder","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"addAdmin","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"addChecker","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"system_id","type":"string"},{"name":"match_result","type":"string"}],"name":"updateOneMatch","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"system_id","type":"string"},{"name":"match_results","type":"string"}],"name":"updateMatches","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"nonce","type":"string"},{"name":"order_info","type":"string"}],"name":"makeOrder","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];
const payload = '60806040526000339050806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055506001600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505061152a806101086000396000f3fe608060405234801561001057600080fd5b506004361061007f576000357c0100000000000000000000000000000000000000000000000000000000900480630c1aa1e31461008457806370480275146100a0578063916473ab146100bc578063b4e30c75146100d8578063cf730a9b146100f4578063dc4c9e9514610110575b600080fd5b61009e6004803603610099919081019061111e565b61012c565b005b6100ba60048036036100b591908101906110f5565b61040f565b005b6100d660048036036100d191908101906110f5565b6104ac565b005b6100f260048036036100ed91908101906111a7565b610549565b005b61010e600480360361010991908101906111a7565b6106e4565b005b61012a600480360361012591908101906111a7565b61082c565b005b60011515600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415156101c1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101b89061143e565b60405180910390fd5b60606102196101cf856109cc565b87878080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050610be2565b90506004816040518082805190602001908083835b602083101515610253578051825260208201915060208101905060208303925061022e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff1615156102d5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102cc9061147e565b60405180910390fd5b60038383604051808383808284378083019250505092505050908152602001604051809103902060009054906101000a900460ff1615151561034c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103439061145e565b60405180910390fd5b6004816040518082805190602001908083835b602083101515610384578051825260208201915060208101905060208303925061035f565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81549060ff0219169055600160038484604051808383808284378083019250505092505050908152602001604051809103902060006101000a81548160ff021916908315150217905550505050505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156104a0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610497906113fe565b60405180910390fd5b6104a981610db5565b50565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561053d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610534906113fe565b60405180910390fd5b61054681610e19565b50565b60011515600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615151415156105de576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105d59061143e565b60405180910390fd5b60038484604051808383808284378083019250505092505050908152602001604051809103902060009054906101000a900460ff161515610654576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161064b9061141e565b60405180910390fd5b6106a182828080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050610e73565b156106de5760038484604051808383808284378083019250505092505050908152602001604051809103902060006101000a81549060ff02191690555b50505050565b60011515600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515141515610779576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107709061143e565b60405180910390fd5b60038484604051808383808284378083019250505092505050908152602001604051809103902060009054906101000a900460ff1615156107ef576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107e69061141e565b60405180910390fd5b60038484604051808383808284378083019250505092505050908152602001604051809103902060006101000a81549060ff021916905550505050565b606061088461083a336109cc565b86868080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050610be2565b90506004816040518082805190602001908083835b6020831015156108be5780518252602082019150602081019050602083039250610899565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff16151515610941576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109389061149e565b60405180910390fd5b60016004826040518082805190602001908083835b60208310151561097b5780518252602082019150602081019050602083039250610956565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505050505050565b60608060286040519080825280601f01601f191660200182016040528015610a035781602001600182028038833980820191505090505b50905060008090505b6014811015610bd85760008160130360080260020a8573ffffffffffffffffffffffffffffffffffffffff16811515610a4157fe5b047f010000000000000000000000000000000000000000000000000000000000000002905060006010827f0100000000000000000000000000000000000000000000000000000000000000900460ff16811515610a9a57fe5b047f01000000000000000000000000000000000000000000000000000000000000000290506000817f01000000000000000000000000000000000000000000000000000000000000009004601002837f01000000000000000000000000000000000000000000000000000000000000009004037f0100000000000000000000000000000000000000000000000000000000000000029050610b3a82610ebb565b8585600202815181101515610b4b57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350610b8481610ebb565b8560018660020201815181101515610b9857fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505050508080600101915050610a0c565b5080915050919050565b6060808390506060839050606081518351016040519080825280601f01601f191660200182016040528015610c265781602001600182028038833980820191505090505b5090506060819050600080905060008090505b8551811015610cec578581815181101515610c5057fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000028383806001019450815181101515610caf57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610c39565b5060008090505b8451811015610da6578481815181101515610d0a57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000028383806001019450815181101515610d6957fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610cf3565b50829550505050505092915050565b6001600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550610e1681610e19565b50565b60018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555050565b6000610eb46040805190810160405280600381526020017f454f46000000000000000000000000000000000000000000000000000000000081525083610f8d565b9050919050565b6000600a827f0100000000000000000000000000000000000000000000000000000000000000900460ff161015610f3c576030827f01000000000000000000000000000000000000000000000000000000000000009004017f0100000000000000000000000000000000000000000000000000000000000000029050610f88565b6057827f01000000000000000000000000000000000000000000000000000000000000009004017f01000000000000000000000000000000000000000000000000000000000000000290505b919050565b600081518351141515610fa3576000905061108f565b816040516020018082805190602001908083835b602083101515610fdc5780518252602082019150602081019050602083039250610fb7565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405160208183030381529060405280519060200120836040516020018082805190602001908083835b602083101515611050578051825260208201915060208101905060208303925061102b565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051602081830303815290604052805190602001201490505b92915050565b60006110a182356114de565b905092915050565b60008083601f84011215156110bd57600080fd5b8235905067ffffffffffffffff8111156110d657600080fd5b6020830191508360018202830111156110ee57600080fd5b9250929050565b60006020828403121561110757600080fd5b600061111584828501611095565b91505092915050565b60008060008060006060868803121561113657600080fd5b600086013567ffffffffffffffff81111561115057600080fd5b61115c888289016110a9565b9550955050602061116f88828901611095565b935050604086013567ffffffffffffffff81111561118c57600080fd5b611198888289016110a9565b92509250509295509295909350565b600080600080604085870312156111bd57600080fd5b600085013567ffffffffffffffff8111156111d757600080fd5b6111e3878288016110a9565b9450945050602085013567ffffffffffffffff81111561120257600080fd5b61120e878288016110a9565b925092505092959194509250565b6000602082527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726020830152604082019050919050565b6000602682527f4f7264657220646f6573206e6f7420657869737420696e20616363657074656460208301527f20626f6f6b2100000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000601782527f43616c6c6572206973206e6f74207468652061646d696e0000000000000000006020830152604082019050919050565b6000602a82527f4f726465722068617320616c72656164792065786973747320696e206163636560208301527f7074656420626f6f6b21000000000000000000000000000000000000000000006040830152606082019050919050565b6000602582527f4f7264657220646f6573206e6f7420657869737420696e2070656e64696e672060208301527f626f6f6b210000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000602982527f4f726465722068617320616c72656164792065786973747320696e2070656e6460208301527f696e6720626f6f6b2100000000000000000000000000000000000000000000006040830152606082019050919050565b600060208201905081810360008301526114178161121c565b9050919050565b6000602082019050818103600083015261143781611253565b9050919050565b60006020820190508181036000830152611457816112b0565b9050919050565b60006020820190508181036000830152611477816112e7565b9050919050565b6000602082019050818103600083015261149781611344565b9050919050565b600060208201905081810360008301526114b7816113a1565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006114e9826114be565b905091905056fea265627a7a72305820d4925f9d35d40233ebefae3929221a92fe262445fc6d2f3fae78c948f84de60b6c6578706572696d656e74616cf50037';

const Remote = jlib.Remote;
const contractRemote = new Remote({server: contractChain.server[0], local_sign: true});

contractRemote.connect(async function(err, res) {

    if(err) {
        return console.log('err: ', err);
    }
    else if(res) {
        console.log('connect: ', res);
    }

    let seq = (await requestInfo.requestAccountInfo(platformAddr, contractRemote, false)).account_data.Sequence;

    let deployRes = await contract.initContract(platformAddr, platformSecret, contractRemote, seq++, abi, payload, true);

    let contractAddr = deployRes.ContractState;
    let abiBuffer = Buffer.from(JSON.stringify(abi));
    let abiHash = await ipfsUtils.add(ipfs, abiBuffer);
    let contractInfo = {
        contract_addr: contractAddr,
        abi_hash: abiHash,
    }
    let sql = sqlText.table('contract_info').data(contractInfo).insert();
    console.log(contractInfo);
    await mysqlUtils.sql(c, sql);

    contractRemote.disconnect();

})
